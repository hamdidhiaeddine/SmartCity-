-- =====================================================
-- SCRIPT DE CRÉATION COMPLÈTE DE LA BASE DE DONNÉES
-- Projet SMARTCITY - Gestion Résidents
-- Schéma : Utilisateur actuel
-- Date : 25 Novembre 2025
-- =====================================================

-- NOTE IMPORTANTE : Ce script crée les tables dans le schéma de l'utilisateur connecté
-- Connectez-vous avec l'utilisateur souhaité avant d'exécuter ce script

-- ÉTAPE 0 : CRÉER L'UTILISATEUR HIBA (optionnel - uniquement pour DBA)
-- =====================================================
-- Décommentez ces lignes si vous êtes connecté en tant que DBA (SYSTEM, SYS)
-- et que vous voulez créer l'utilisateur HIBA

/*
-- Supprimer l'utilisateur s'il existe
BEGIN
   EXECUTE IMMEDIATE 'DROP USER HIBA CASCADE';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

-- Créer l'utilisateur HIBA
CREATE USER HIBA IDENTIFIED BY esprit18
    DEFAULT TABLESPACE USERS
    TEMPORARY TABLESPACE TEMP
    QUOTA UNLIMITED ON USERS;

-- Donner les privilèges nécessaires
GRANT CONNECT, RESOURCE TO HIBA;
GRANT CREATE VIEW TO HIBA;
GRANT CREATE SEQUENCE TO HIBA;
GRANT CREATE TRIGGER TO HIBA;
GRANT CREATE TABLE TO HIBA;
GRANT UNLIMITED TABLESPACE TO HIBA;

-- Message de confirmation
SELECT 'Utilisateur HIBA créé avec succès!' AS MESSAGE FROM DUAL;
*/

-- =====================================================
BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GEST_RESIDENT_MAISON CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GEST_RESIDENT_JARDIN CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE HIST_RESIDENT CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE HISTORIQUE_RESIDENT CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GEST_VEHICULE CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GEST_EMPLOYE CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GEST_CABINET CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GEST_JARDIN CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GEST_MAISON CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GEST_RESIDENT CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

-- Supprimer les séquences
BEGIN
   EXECUTE IMMEDIATE 'DROP SEQUENCE HISTORIQUE_RESIDENT_SEQ';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

-- =====================================================
-- ÉTAPE 2 : CRÉER LES TABLES PRINCIPALES
-- =====================================================

-- TABLE : GEST_RESIDENT (Résidents)
-- =====================================================
CREATE TABLE GEST_RESIDENT (
    ID NUMBER(10) PRIMARY KEY,
    NOM VARCHAR2(50 BYTE) NOT NULL,
    PRENOM VARCHAR2(50 BYTE) NOT NULL,
    DATENAISS DATE,
    ADRESSE VARCHAR2(100) NOT NULL,
    TELEPHONE VARCHAR2(15 BYTE) NOT NULL,
    EMAIL VARCHAR2(50 BYTE) NOT NULL,
    STATUT VARCHAR2(15 BYTE) NOT NULL,
    SITUATIONFAMILIALE VARCHAR2(15 BYTE) NOT NULL
);

-- TABLE : GEST_VEHICULE (Véhicules)
-- =====================================================
CREATE TABLE GEST_VEHICULE (
    IMMATRICULATION NUMBER(10) PRIMARY KEY,
    MARQUE VARCHAR2(20 BYTE),
    MODELE VARCHAR2(20 BYTE),
    TYPE VARCHAR2(15 BYTE),
    ETAT VARCHAR2(10 BYTE),
    SERVICE VARCHAR2(50 BYTE),
    DATEMAINTENCE DATE,
    ID_RESIDENT NUMBER(10),
    CONSTRAINT FK_VEHICULE_RESIDENT FOREIGN KEY (ID_RESIDENT) 
        REFERENCES GEST_RESIDENT(ID) ON DELETE CASCADE
);

-- TABLE : GEST_EMPLOYE (Employés)
-- =====================================================
CREATE TABLE GEST_EMPLOYE (
    ID NUMBER(10) PRIMARY KEY,
    NOM VARCHAR2(50 BYTE) NOT NULL,
    PRENOM VARCHAR2(50 BYTE) NOT NULL,
    EMAIL VARCHAR2(50 BYTE),
    POSTE VARCHAR2(50 BYTE),
    SALAIRE NUMBER(10),
    ID_RESIDENT NUMBER(10),
    CONSTRAINT FK_EMPLOYE_RESIDENT FOREIGN KEY (ID_RESIDENT) 
        REFERENCES GEST_RESIDENT(ID) ON DELETE SET NULL
);

-- TABLE : GEST_CABINET (Cabinets)
-- =====================================================
CREATE TABLE GEST_CABINET (
    ID NUMBER(10) PRIMARY KEY,
    NOM VARCHAR2(50 BYTE) NOT NULL,
    ADRESSE VARCHAR2(100 BYTE),
    SPECIALITE VARCHAR2(15 BYTE),
    TELEPHONE VARCHAR2(50 BYTE),
    EMAIL VARCHAR2(50 BYTE),
    ID_RESIDENT NUMBER(10),
    CONSTRAINT FK_CABINET_RESIDENT FOREIGN KEY (ID_RESIDENT) 
        REFERENCES GEST_RESIDENT(ID) ON DELETE SET NULL
);

-- TABLE : GEST_JARDIN (Jardins)
-- =====================================================
CREATE TABLE GEST_JARDIN (
    ID_JARDIN NUMBER PRIMARY KEY,
    NOM VARCHAR2(100 BYTE),
    ADRESSE VARCHAR2(100 BYTE),
    SUPERFICIE NUMBER(10,2),
    TYPE_JARDIN VARCHAR2(50 BYTE),
    DATE_CREATION DATE
);

-- TABLE : GEST_MAISON (Maisons)
-- =====================================================
CREATE TABLE GEST_MAISON (
    ID_MAISON NUMBER PRIMARY KEY,
    ADRESSE VARCHAR2(100 BYTE) NOT NULL,
    SUPERFICIE NUMBER(10,2),
    NOMBRE_PIECES NUMBER(10),
    TYPE_MAISON VARCHAR2(50 BYTE),
    PRIX_LOCATION NUMBER(10,2)
);

-- =====================================================
-- ÉTAPE 3 : CRÉER LES TABLES D'ASSOCIATION
-- =====================================================

-- TABLE : GEST_RESIDENT_JARDIN (Relation Résident-Jardin)
-- =====================================================
CREATE TABLE GEST_RESIDENT_JARDIN (
    ID_RESIDENT NUMBER(10),
    ID_JARDIN NUMBER,
    DATE_ACCES DATE,
    CONSTRAINT GEST_RESIDENT_JARDIN_PK PRIMARY KEY (ID_RESIDENT, ID_JARDIN),
    CONSTRAINT FK_RJ_RESIDENT FOREIGN KEY (ID_RESIDENT) 
        REFERENCES GEST_RESIDENT(ID) ON DELETE CASCADE,
    CONSTRAINT FK_RJ_JARDIN FOREIGN KEY (ID_JARDIN) 
        REFERENCES GEST_JARDIN(ID_JARDIN) ON DELETE CASCADE
);

-- TABLE : GEST_RESIDENT_MAISON (Relation Résident-Maison)
-- =====================================================
CREATE TABLE GEST_RESIDENT_MAISON (
    ID_RESIDENT NUMBER(10),
    ID_MAISON NUMBER,
    DATE_EMMENAGEMENT DATE,
    STATUT_OCCUPATION VARCHAR2(50 BYTE),
    CONSTRAINT GEST_RESIDENT_MAISON_PK PRIMARY KEY (ID_RESIDENT, ID_MAISON),
    CONSTRAINT FK_RM_RESIDENT FOREIGN KEY (ID_RESIDENT) 
        REFERENCES GEST_RESIDENT(ID) ON DELETE CASCADE,
    CONSTRAINT FK_RM_MAISON FOREIGN KEY (ID_MAISON) 
        REFERENCES GEST_MAISON(ID_MAISON) ON DELETE CASCADE
);

-- =====================================================
-- ÉTAPE 4 : CRÉER LA TABLE HISTORIQUE
-- =====================================================

-- TABLE : HIST_RESIDENT (Historique des actions)
-- =====================================================
CREATE TABLE HIST_RESIDENT (
    ID_HISTORIQUE NUMBER PRIMARY KEY,
    ID_RESIDENT NUMBER,
    ACTION VARCHAR2(50 BYTE) NOT NULL,
    DATE_ACTION DATE DEFAULT SYSDATE NOT NULL
);

-- Créer aussi le synonyme HISTORIQUE_RESIDENT
CREATE TABLE HISTORIQUE_RESIDENT (
    ID_HISTORIQUE NUMBER PRIMARY KEY,
    ID_RESIDENT NUMBER NOT NULL,
    ACTION VARCHAR2(50) NOT NULL,
    DATE_ACTION DATE DEFAULT SYSDATE NOT NULL
);

-- =====================================================
-- ÉTAPE 5 : CRÉER LES SÉQUENCES
-- =====================================================

-- Séquence pour l'historique
CREATE SEQUENCE HISTORIQUE_RESIDENT_SEQ
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- =====================================================
-- ÉTAPE 6 : CRÉER LES TRIGGERS
-- =====================================================

-- Trigger pour auto-incrémenter l'ID de l'historique
CREATE OR REPLACE TRIGGER TRG_HISTORIQUE_RESIDENT_ID
    BEFORE INSERT ON HISTORIQUE_RESIDENT
    FOR EACH ROW
BEGIN
    IF :NEW.ID_HISTORIQUE IS NULL THEN
        SELECT HISTORIQUE_RESIDENT_SEQ.NEXTVAL INTO :NEW.ID_HISTORIQUE FROM DUAL;
    END IF;
END;
/

-- Trigger pour HIST_RESIDENT
CREATE OR REPLACE TRIGGER TRG_HIST_RESIDENT_ID
    BEFORE INSERT ON HIST_RESIDENT
    FOR EACH ROW
BEGIN
    IF :NEW.ID_HISTORIQUE IS NULL THEN
        SELECT HISTORIQUE_RESIDENT_SEQ.NEXTVAL INTO :NEW.ID_HISTORIQUE FROM DUAL;
    END IF;
END;
/

-- Trigger pour enregistrer automatiquement les AJOUTS de résidents
CREATE OR REPLACE TRIGGER TRG_AUTO_HISTORIQUE_RESIDENT
    AFTER INSERT ON GEST_RESIDENT
    FOR EACH ROW
BEGIN
    INSERT INTO HISTORIQUE_RESIDENT (ID_RESIDENT, ACTION, DATE_ACTION)
    VALUES (:NEW.ID, 'Ajout', SYSDATE);
    
    INSERT INTO HIST_RESIDENT (ID_RESIDENT, ACTION, DATE_ACTION)
    VALUES (:NEW.ID, 'Ajout', SYSDATE);
END;
/

-- Trigger pour enregistrer automatiquement les MODIFICATIONS de résidents
CREATE OR REPLACE TRIGGER TRG_AUTO_HIST_RES_UPDATE
    AFTER UPDATE ON GEST_RESIDENT
    FOR EACH ROW
BEGIN
    INSERT INTO HISTORIQUE_RESIDENT (ID_RESIDENT, ACTION, DATE_ACTION)
    VALUES (:NEW.ID, 'Modification', SYSDATE);
    
    INSERT INTO HIST_RESIDENT (ID_RESIDENT, ACTION, DATE_ACTION)
    VALUES (:NEW.ID, 'Modification', SYSDATE);
END;
/

-- Trigger pour enregistrer automatiquement les SUPPRESSIONS de résidents
CREATE OR REPLACE TRIGGER TRG_AUTO_HIST_RES_DELETE
    AFTER DELETE ON GEST_RESIDENT
    FOR EACH ROW
BEGIN
    INSERT INTO HISTORIQUE_RESIDENT (ID_RESIDENT, ACTION, DATE_ACTION)
    VALUES (:OLD.ID, 'Suppression', SYSDATE);
    
    INSERT INTO HIST_RESIDENT (ID_RESIDENT, ACTION, DATE_ACTION)
    VALUES (:OLD.ID, 'Suppression', SYSDATE);
END;
/

-- =====================================================
-- ÉTAPE 7 : CRÉER LES INDEX pour améliorer les performances
-- =====================================================

-- Index sur les clés étrangères
CREATE INDEX IDX_VEHICULE_RESIDENT ON GEST_VEHICULE(ID_RESIDENT);
CREATE INDEX IDX_EMPLOYE_RESIDENT ON GEST_EMPLOYE(ID_RESIDENT);
CREATE INDEX IDX_CABINET_RESIDENT ON GEST_CABINET(ID_RESIDENT);

-- Index sur les colonnes de recherche fréquente
CREATE INDEX IDX_RESIDENT_NOM ON GEST_RESIDENT(NOM);
CREATE INDEX IDX_RESIDENT_EMAIL ON GEST_RESIDENT(EMAIL);
CREATE INDEX IDX_RESIDENT_TELEPHONE ON GEST_RESIDENT(TELEPHONE);

-- Index sur l'historique
CREATE INDEX IDX_HIST_RESIDENT_ID ON HISTORIQUE_RESIDENT(ID_RESIDENT);
CREATE INDEX IDX_HIST_DATE_ACTION ON HISTORIQUE_RESIDENT(DATE_ACTION);
CREATE INDEX IDX_HIST_ACTION ON HISTORIQUE_RESIDENT(ACTION);

CREATE INDEX IDX_HIST2_RESIDENT_ID ON HIST_RESIDENT(ID_RESIDENT);
CREATE INDEX IDX_HIST2_DATE_ACTION ON HIST_RESIDENT(DATE_ACTION);

-- =====================================================
-- ÉTAPE 8 : INSÉRER DES DONNÉES DE TEST
-- =====================================================

-- Insérer des résidents de test
INSERT INTO GEST_RESIDENT (ID, NOM, PRENOM, DATENAISS, ADRESSE, TELEPHONE, EMAIL, STATUT, SITUATIONFAMILIALE)
VALUES (1, 'Dupont', 'Jean', TO_DATE('1985-05-15', 'YYYY-MM-DD'), '123 Rue de Paris', '+33123456789', 'jean.dupont@email.com', 'Actif', 'Marié');

INSERT INTO GEST_RESIDENT (ID, NOM, PRENOM, DATENAISS, ADRESSE, TELEPHONE, EMAIL, STATUT, SITUATIONFAMILIALE)
VALUES (2, 'Martin', 'Sophie', TO_DATE('1990-08-22', 'YYYY-MM-DD'), '456 Avenue des Champs', '+33987654321', 'sophie.martin@email.com', 'Actif', 'Célibataire');

INSERT INTO GEST_RESIDENT (ID, NOM, PRENOM, DATENAISS, ADRESSE, TELEPHONE, EMAIL, STATUT, SITUATIONFAMILIALE)
VALUES (3, 'Bernard', 'Luc', TO_DATE('1978-12-10', 'YYYY-MM-DD'), '789 Boulevard Victor Hugo', '+33567891234', 'luc.bernard@email.com', 'Actif', 'Divorcé');

-- Insérer des véhicules de test
INSERT INTO GEST_VEHICULE (IMMATRICULATION, MARQUE, MODELE, TYPE, ETAT, SERVICE, DATEMAINTENCE, ID_RESIDENT)
VALUES (1001, 'Renault', 'Clio', 'Citadine', 'Bon', 'Révision complète', TO_DATE('2025-01-15', 'YYYY-MM-DD'), 1);

INSERT INTO GEST_VEHICULE (IMMATRICULATION, MARQUE, MODELE, TYPE, ETAT, SERVICE, DATEMAINTENCE, ID_RESIDENT)
VALUES (1002, 'Peugeot', '308', 'Berline', 'Excellent', 'Vidange', TO_DATE('2025-02-20', 'YYYY-MM-DD'), 2);

-- Insérer des employés de test
INSERT INTO GEST_EMPLOYE (ID, NOM, PRENOM, EMAIL, POSTE, SALAIRE, ID_RESIDENT)
VALUES (501, 'Dubois', 'Marie', 'marie.dubois@smartcity.com', 'Technicienne', 2500, 1);

INSERT INTO GEST_EMPLOYE (ID, NOM, PRENOM, EMAIL, POSTE, SALAIRE, ID_RESIDENT)
VALUES (502, 'Lambert', 'Pierre', 'pierre.lambert@smartcity.com', 'Ingénieur', 3500, 2);

-- Insérer des cabinets de test
INSERT INTO GEST_CABINET (ID, NOM, ADRESSE, SPECIALITE, TELEPHONE, EMAIL, ID_RESIDENT)
VALUES (301, 'Cabinet Médical Central', '12 Place de la Santé', 'Médecine', '+33145678901', 'contact@cabinet-central.fr', NULL);

INSERT INTO GEST_CABINET (ID, NOM, ADRESSE, SPECIALITE, TELEPHONE, EMAIL, ID_RESIDENT)
VALUES (302, 'Cabinet Dentaire', '25 Rue du Sourire', 'Dentaire', '+33156789012', 'rdv@cabinet-dentaire.fr', NULL);

-- Insérer des jardins de test
INSERT INTO GEST_JARDIN (ID_JARDIN, NOM, ADRESSE, SUPERFICIE, TYPE_JARDIN, DATE_CREATION)
VALUES (201, 'Jardin des Roses', '1 Avenue des Fleurs', 5000.50, 'Public', TO_DATE('2020-03-15', 'YYYY-MM-DD'));

INSERT INTO GEST_JARDIN (ID_JARDIN, NOM, ADRESSE, SUPERFICIE, TYPE_JARDIN, DATE_CREATION)
VALUES (202, 'Jardin Communautaire', '45 Rue Verte', 3500.75, 'Communautaire', TO_DATE('2021-06-01', 'YYYY-MM-DD'));

-- Insérer des maisons de test
INSERT INTO GEST_MAISON (ID_MAISON, ADRESSE, SUPERFICIE, NOMBRE_PIECES, TYPE_MAISON, PRIX_LOCATION)
VALUES (101, '10 Rue des Lilas', 120.50, 5, 'Pavillon', 1200.00);

INSERT INTO GEST_MAISON (ID_MAISON, ADRESSE, SUPERFICIE, NOMBRE_PIECES, TYPE_MAISON, PRIX_LOCATION)
VALUES (102, '22 Avenue du Parc', 95.00, 4, 'Appartement', 950.00);

-- Insérer des relations résident-jardin
INSERT INTO GEST_RESIDENT_JARDIN (ID_RESIDENT, ID_JARDIN, DATE_ACCES)
VALUES (1, 201, TO_DATE('2025-01-10', 'YYYY-MM-DD'));

INSERT INTO GEST_RESIDENT_JARDIN (ID_RESIDENT, ID_JARDIN, DATE_ACCES)
VALUES (2, 202, TO_DATE('2025-01-15', 'YYYY-MM-DD'));

-- Insérer des relations résident-maison
INSERT INTO GEST_RESIDENT_MAISON (ID_RESIDENT, ID_MAISON, DATE_EMMENAGEMENT, STATUT_OCCUPATION)
VALUES (1, 101, TO_DATE('2024-06-01', 'YYYY-MM-DD'), 'Propriétaire');

INSERT INTO GEST_RESIDENT_MAISON (ID_RESIDENT, ID_MAISON, DATE_EMMENAGEMENT, STATUT_OCCUPATION)
VALUES (2, 102, TO_DATE('2024-09-15', 'YYYY-MM-DD'), 'Locataire');

-- =====================================================
-- ÉTAPE 9 : VALIDATION
-- =====================================================

-- Afficher le nombre d'enregistrements dans chaque table
SELECT 'GEST_RESIDENT' AS TABLE_NAME, COUNT(*) AS NB_RECORDS FROM GEST_RESIDENT
UNION ALL
SELECT 'GEST_VEHICULE', COUNT(*) FROM GEST_VEHICULE
UNION ALL
SELECT 'GEST_EMPLOYE', COUNT(*) FROM GEST_EMPLOYE
UNION ALL
SELECT 'GEST_CABINET', COUNT(*) FROM GEST_CABINET
UNION ALL
SELECT 'GEST_JARDIN', COUNT(*) FROM GEST_JARDIN
UNION ALL
SELECT 'GEST_MAISON', COUNT(*) FROM GEST_MAISON
UNION ALL
SELECT 'GEST_RESIDENT_JARDIN', COUNT(*) FROM GEST_RESIDENT_JARDIN
UNION ALL
SELECT 'GEST_RESIDENT_MAISON', COUNT(*) FROM GEST_RESIDENT_MAISON
UNION ALL
SELECT 'HISTORIQUE_RESIDENT', COUNT(*) FROM HISTORIQUE_RESIDENT
UNION ALL
SELECT 'HIST_RESIDENT', COUNT(*) FROM HIST_RESIDENT;

-- Afficher les triggers créés
SELECT TRIGGER_NAME, STATUS, TRIGGER_TYPE
FROM USER_TRIGGERS
WHERE TRIGGER_NAME LIKE '%HISTORIQUE%' OR TRIGGER_NAME LIKE '%HIST%'
ORDER BY TRIGGER_NAME;

-- Message de confirmation
SELECT '=== BASE DE DONNÉES CRÉÉE AVEC SUCCÈS ===' AS MESSAGE FROM DUAL;
SELECT 'Toutes les tables, triggers et données de test ont été créés.' AS MESSAGE FROM DUAL;
SELECT 'Vous pouvez maintenant utiliser l''application Qt.' AS MESSAGE FROM DUAL;

COMMIT;
